name: Docker Image Sync to Aliyun

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 23 * * *'  # æ¯æ—¥ UTC 23:00ï¼ˆåŒ—äº¬æ—¶é—´ 7:00ï¼‰

env:
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAME_SPACE }}
  ALIYUN_USER: ${{ secrets.ALIYUN_REGISTRY_USER }}
  ALIYUN_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
  IMAGE_LIST_FILE: "images.txt"  # é›†ä¸­ç®¡ç†é•œåƒåˆ—è¡¨æ–‡ä»¶è·¯å¾„

jobs:
  sync-images:
    name: Sync Docker Images to Aliyun
    runs-on: ubuntu-latest
    permissions:
      contents: read  # ä»…éœ€è¯»å–ä»£ç æƒé™

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # ä»…è·å–æœ€æ–°æäº¤ï¼Œå‡å°‘ä¸‹è½½é‡

    - name: Set Up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        install: true  # ç¡®ä¿å®‰è£… Buildx

    - name: Login to Aliyun Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ALIYUN_REGISTRY }}
        username: ${{ env.ALIYUN_USER }}
        password: ${{ env.ALIYUN_PASSWORD }}

    - name: Process Image List
      run: |
        set -euo pipefail  # ä¸¥æ ¼é”™è¯¯å¤„ç†ï¼šé‡åˆ°æœªå®šä¹‰å˜é‡/å‘½ä»¤å¤±è´¥ç«‹å³ç»ˆæ­¢

        # åˆå§‹åŒ–å˜é‡
        declare -A conflictingImages  # è®°å½•åç§°å†²çªçš„é•œåƒï¼ˆé”®ï¼šé•œåƒåï¼Œå€¼ï¼šæ˜¯å¦å†²çªï¼‰
        declare -A namespaceMap       # è®°å½•é•œåƒåå¯¹åº”çš„åŸå§‹å‘½åç©ºé—´ï¼ˆç”¨äºå†²çªæ£€æµ‹ï¼‰
        errorImages=()                # è®°å½•å¤„ç†å¤±è´¥çš„é•œåƒï¼ˆå»æ‰ local å…³é”®å­—ï¼‰

        # å‡½æ•°ï¼šæå–é•œåƒåŸºç¡€ä¿¡æ¯ï¼ˆåç§°ã€æ ‡ç­¾ã€åŸå§‹å‘½åç©ºé—´ï¼‰
        extract_image_info() {
          local image="$1"
          local nameTag=$(basename "$image")        # æ ¼å¼ï¼šname:tag
          local namespace=$(dirname "$image" | cut -d/ -f1)  # åŸå§‹å‘½åç©ºé—´ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
          local name=$(echo "$nameTag" | cut -d: -f1)
          local tag=$(echo "$nameTag" | cut -d: -f2-)
          echo "$nameTag $namespace $name $tag"     # è¾“å‡ºï¼šæ ‡ç­¾å å‘½åç©ºé—´ é•œåƒå æ ‡ç­¾
        }

        # ç¬¬ä¸€æ­¥ï¼šæ£€æµ‹é•œåƒåç§°å†²çªï¼ˆä¸åŒå‘½åç©ºé—´ä¸‹çš„åŒåé•œåƒï¼‰
        echo "ğŸ” å¼€å§‹æ£€æµ‹é•œåƒåç§°å†²çª..."
        while IFS= read -r line; do
          [[ -z "$line" ]] && continue
          # å¿½ç•¥æ³¨é‡Šè¡Œï¼ˆä»¥#å¼€å¤´ï¼‰
          [[ "$line" =~ ^#.* ]] && continue
          
          # æå–é•œåƒï¼ˆå¿½ç•¥--platformå‚æ•°ï¼‰
          local image=$(echo "$line" | awk '{for(i=1;i<=NF;i++) if ($i !~ /^--platform=/) image=$i; print image}')
          # æå–é•œåƒä¿¡æ¯
          local nameTag namespace name tag
          read -r nameTag namespace name tag <<< "$(extract_image_info "$image")"

          # å†²çªæ£€æµ‹é€»è¾‘
          if [[ -n "${namespaceMap[$name]}" ]]; then
            if [[ "${namespaceMap[$name]}" != "$namespace" ]]; then
              conflictingImages["$name"]=true
              echo "âš ï¸ æ£€æµ‹åˆ°åç§°å†²çªé•œåƒ: $nameï¼ˆåŸå‘½åç©ºé—´: ${namespaceMap[$name]}, å½“å‰: $namespaceï¼‰"
            fi
          else
            namespaceMap["$name"]="$namespace"
          fi
        done < "$IMAGE_LIST_FILE"

        # ç¬¬äºŒæ­¥ï¼šå¤„ç†æ¯ä¸ªé•œåƒï¼ˆæ‹‰å–ã€æ‰“æ ‡ç­¾ã€æ¨é€ï¼‰
        echo "ğŸš€ å¼€å§‹å¤„ç†é•œåƒåˆ—è¡¨..."
        while IFS= read -r line; do
          [[ -z "$line" ]] && continue
          [[ "$line" =~ ^#.* ]] && continue  # è·³è¿‡æ³¨é‡Šè¡Œ

          echo -e "\nğŸ”§ å¤„ç†é•œåƒè¡Œ: $line"
          local platform=$(echo "$line" | grep -oP -- '--platform=\K\S+')  # æå–platformå‚æ•°ï¼ˆæ›´å¯é ï¼‰
          local image=$(echo "$line" | awk '{for(i=1;i<=NF;i++) if ($i !~ /^--platform=/) image=$i; print image}')

          # æå–é•œåƒä¿¡æ¯
          local nameTag namespace name tag
          read -r nameTag namespace name tag <<< "$(extract_image_info "$image")"

          # æ­¥éª¤1ï¼šæ‹‰å–é•œåƒï¼ˆæ”¯æŒå¤šå¹³å°ï¼‰
          echo "â¬ æ‹‰å–é•œåƒ: $image"
          if ! docker pull --platform "${platform:-linux/amd64}" "$image"; then
            echo "âŒ æ‹‰å–å¤±è´¥: $image"
            errorImages+=("$image")
            continue
          fi

          # æ­¥éª¤2ï¼šç”Ÿæˆæ–°é•œåƒæ ‡ç­¾ï¼ˆè€ƒè™‘å¹³å°ã€å‘½åç©ºé—´å†²çªï¼‰
          local platformPrefix=${platform//\//_}_
          local namespacePrefix=""
          [[ -n "${conflictingImages[$name]}" && -n "$namespace" ]] && namespacePrefix="${namespace}_"
          local newImage="${ALIYUN_REGISTRY}/${ALIYUN_NAMESPACE}/${platformPrefix}${namespacePrefix}${nameTag}"

          # æ­¥éª¤3ï¼šæ‰“æ ‡ç­¾ï¼ˆé¿å…é‡å¤æ ‡ç­¾å¯¼è‡´é”™è¯¯ï¼‰
          echo "ğŸ·ï¸ æ‰“æ ‡ç­¾: $image â†’ $newImage"
          if ! docker tag "$image" "$newImage"; then
            echo "âŒ æ‰“æ ‡ç­¾å¤±è´¥: $image â†’ $newImage"
            errorImages+=("$image")
            continue
          fi

          # æ­¥éª¤4ï¼šæ¨é€é•œåƒï¼ˆå¯ç”¨å‹ç¼©æé«˜é€Ÿåº¦ï¼‰
          echo "ğŸš€ æ¨é€é•œåƒ: $newImage"
          if ! docker push --quiet "$newImage"; then  # --quiet å‡å°‘æ—¥å¿—è¾“å‡º
            echo "âŒ æ¨é€å¤±è´¥: $newImage"
            errorImages+=("$newImage")
            continue
          fi

          echo "âœ… æˆåŠŸå¤„ç†: $newImage"
        done < "$IMAGE_LIST_FILE"

        # æœ€ç»ˆç»“æœæ±‡æ€»
        echo -e "\n========================================"
        if [[ ${#errorImages[@]} -gt 0 ]]; then
          echo "âš ï¸ å¤„ç†å¤±è´¥ï¼ˆ${#errorImages[@]} ä¸ªé•œåƒï¼‰:"
          printf -- "- %s\n" "${errorImages[@]}"
          exit 1  # æ ‡è®°å·¥ä½œæµå¤±è´¥
        else
          echo "ğŸ‰ æ‰€æœ‰é•œåƒå¤„ç†æˆåŠŸï¼"
        fi
